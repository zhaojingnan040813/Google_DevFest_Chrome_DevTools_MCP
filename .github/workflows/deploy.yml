# GitHub Actions å·¥ä½œæµ - è‡ªåŠ¨éƒ¨ç½² DevFest Workshop ç½‘ç«™
# ä½œè€…: èµµæ™¯å—
# åŠŸèƒ½: è‡ªåŠ¨æ„å»ºå’Œéƒ¨ç½²é™æ€ç½‘ç«™åˆ° GitHub Pages

name: Deploy DevFest Workshop Website

# è§¦å‘æ¡ä»¶
on:
  # å½“æ¨é€åˆ° main åˆ†æ”¯æ—¶è§¦å‘
  push:
    branches: [ main ]
  
  # å½“åˆ›å»º Pull Request åˆ° main åˆ†æ”¯æ—¶è§¦å‘
  pull_request:
    branches: [ main ]
  
  # å…è®¸æ‰‹åŠ¨è§¦å‘å·¥ä½œæµ
  workflow_dispatch:

# è®¾ç½®æƒé™
permissions:
  contents: read
  pages: write
  id-token: write

# å¹¶å‘æ§åˆ¶ - ç¡®ä¿åŒæ—¶åªæœ‰ä¸€ä¸ªéƒ¨ç½²åœ¨è¿è¡Œ
concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  # æ„å»ºä½œä¸š
  build:
    name: æ„å»ºç½‘ç«™
    runs-on: ubuntu-latest
    
    steps:
    # æ£€å‡ºä»£ç 
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    # è®¾ç½® Node.js ç¯å¢ƒï¼ˆå¦‚æœéœ€è¦å¤„ç†ä¾èµ–ï¼‰
    - name: è®¾ç½® Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
      
    # å®‰è£…ä¾èµ–ï¼ˆå¦‚æœæœ‰ package.jsonï¼‰
    - name: å®‰è£…ä¾èµ–
      run: |
        if [ -f package.json ]; then
          npm ci
        else
          echo "æ²¡æœ‰æ‰¾åˆ° package.jsonï¼Œè·³è¿‡ä¾èµ–å®‰è£…"
        fi
    
    # è¿è¡Œæ„å»ºè„šæœ¬ï¼ˆå¦‚æœæœ‰ï¼‰
    - name: æ„å»ºé¡¹ç›®
      run: |
        if [ -f package.json ] && npm run build --if-present; then
          echo "æ„å»ºå®Œæˆ"
        else
          echo "æ²¡æœ‰æ„å»ºè„šæœ¬ï¼Œä½¿ç”¨é™æ€æ–‡ä»¶"
          mkdir -p dist
          cp -r *.html *.css *.js dist/ 2>/dev/null || true
          if [ ! -d dist ] || [ -z "$(ls -A dist)" ]; then
            mkdir -p dist
            cp -r . dist/
            rm -rf dist/.git dist/.github dist/node_modules 2>/dev/null || true
          fi
        fi
    
    # éªŒè¯ç½‘ç«™æ–‡ä»¶
    - name: éªŒè¯ç½‘ç«™æ–‡ä»¶
      run: |
        echo "æ£€æŸ¥ç½‘ç«™æ–‡ä»¶..."
        if [ -d dist ]; then
          ls -la dist/
          if [ -f dist/index.html ]; then
            echo "âœ… æ‰¾åˆ° index.html"
          else
            echo "âŒ æœªæ‰¾åˆ° index.html"
            exit 1
          fi
        else
          echo "æ£€æŸ¥æ ¹ç›®å½•æ–‡ä»¶..."
          ls -la
          if [ -f index.html ]; then
            echo "âœ… æ‰¾åˆ° index.html"
          else
            echo "âŒ æœªæ‰¾åˆ° index.html"
            exit 1
          fi
        fi
    
    # è®¾ç½® GitHub Pages
    - name: è®¾ç½® GitHub Pages
      uses: actions/configure-pages@v4
    
    # ä¸Šä¼ æ„å»ºäº§ç‰©
    - name: ä¸Šä¼ æ„å»ºäº§ç‰©
      uses: actions/upload-pages-artifact@v3
      with:
        path: ${{ (hashFiles('dist/**') != '' && 'dist') || '.' }}

  # éƒ¨ç½²ä½œä¸š
  deploy:
    name: éƒ¨ç½²åˆ° GitHub Pages
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    
    # åªåœ¨æ¨é€åˆ° main åˆ†æ”¯æ—¶éƒ¨ç½²
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
    - name: éƒ¨ç½²åˆ° GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4
    
    # éƒ¨ç½²æˆåŠŸé€šçŸ¥
    - name: éƒ¨ç½²æˆåŠŸé€šçŸ¥
      run: |
        echo "ğŸ‰ DevFest Workshop ç½‘ç«™éƒ¨ç½²æˆåŠŸï¼"
        echo "ğŸ“± ç½‘ç«™åœ°å€: ${{ steps.deployment.outputs.page_url }}"
        echo "ğŸš€ éƒ¨ç½²æ—¶é—´: $(date)"

  # ä»£ç è´¨é‡æ£€æŸ¥ä½œä¸š
  quality-check:
    name: ä»£ç è´¨é‡æ£€æŸ¥
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
    
    # HTML éªŒè¯
    - name: HTML éªŒè¯
      run: |
        echo "æ£€æŸ¥ HTML æ–‡ä»¶è¯­æ³•..."
        for file in *.html; do
          if [ -f "$file" ]; then
            echo "æ£€æŸ¥ $file"
            # ç®€å•çš„ HTML è¯­æ³•æ£€æŸ¥
            if grep -q "<!DOCTYPE html>" "$file" && grep -q "<html" "$file" && grep -q "</html>" "$file"; then
              echo "âœ… $file è¯­æ³•æ­£ç¡®"
            else
              echo "âš ï¸ $file å¯èƒ½å­˜åœ¨è¯­æ³•é—®é¢˜"
            fi
          fi
        done
    
    # CSS éªŒè¯
    - name: CSS éªŒè¯
      run: |
        echo "æ£€æŸ¥ CSS æ–‡ä»¶..."
        for file in *.css; do
          if [ -f "$file" ]; then
            echo "æ£€æŸ¥ $file"
            # æ£€æŸ¥ CSS æ–‡ä»¶æ˜¯å¦å­˜åœ¨åŸºæœ¬è¯­æ³•é”™è¯¯
            if [ -s "$file" ]; then
              echo "âœ… $file å­˜åœ¨ä¸”éç©º"
            else
              echo "âš ï¸ $file ä¸ºç©ºæˆ–ä¸å­˜åœ¨"
            fi
          fi
        done
    
    # JavaScript è¯­æ³•æ£€æŸ¥
    - name: JavaScript è¯­æ³•æ£€æŸ¥
      run: |
        echo "æ£€æŸ¥ JavaScript æ–‡ä»¶..."
        for file in *.js; do
          if [ -f "$file" ]; then
            echo "æ£€æŸ¥ $file"
            # ä½¿ç”¨ node æ£€æŸ¥ JS è¯­æ³•
            if node -c "$file" 2>/dev/null; then
              echo "âœ… $file è¯­æ³•æ­£ç¡®"
            else
              echo "âš ï¸ $file å¯èƒ½å­˜åœ¨è¯­æ³•é”™è¯¯"
            fi
          fi
        done
    
    # æ£€æŸ¥å“åº”å¼è®¾è®¡
    - name: æ£€æŸ¥å“åº”å¼è®¾è®¡
      run: |
        echo "æ£€æŸ¥å“åº”å¼è®¾è®¡..."
        if grep -q "@media" styles.css; then
          echo "âœ… å‘ç°å“åº”å¼è®¾è®¡ä»£ç "
        else
          echo "âš ï¸ æœªå‘ç°å“åº”å¼è®¾è®¡ä»£ç "
        fi
        
        if grep -q "viewport" *.html; then
          echo "âœ… å‘ç° viewport è®¾ç½®"
        else
          echo "âš ï¸ æœªå‘ç° viewport è®¾ç½®"
        fi